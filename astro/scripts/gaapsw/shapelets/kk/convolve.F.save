c
c convolution ignoring pixellation effects.
c
      subroutine convolve(shape1,shape2,betaout,result)
      real shape1(msh),shape2(msh),result(msh)
      real c1d(0:mm,0:mm,0:mm),cmat(msh-2,msh-2,msh-2),el(0:mm,0:mm,0:mm)

      beta1=shape1(1)
      n1=shape1(2)
      beta2=shape2(1)
      n2=shape2(2)

      n=max(n1,n2)
      result(1)=betaout
      result(2)=n
c
c construct the 1-D C matrix (Refregier et at paper II) 
c 
      a1=1/betaout
      a2=1/beta1
      a3=1/beta2
      anu=sqrt(1./(1./a1**2+1./a2**2+1./a3**2))
      a=sqrt(2.)*anu/a1
      b=sqrt(2.)*anu/a2
      c=sqrt(2.)*anu/a3
      a2min1=a*a-1
      b2min1=b*b-1
      c2min1=c*c-1
      ab=a*b
      bc=b*c
      ac=a*c
c first construct the edges (only 1 nonzero cpt) of the el matrix = L(a,b,c)
      el(0,0,0)=1/sqrt(3.1415926535)
c      el(1,0,0)=0
c      el(0,1,0)=0
c      el(0,0,1)=0
      do ii=1,n-1,2
          write(*,*) ii+1,0,0
          el(ii+1,0,0)=2*ii*a2min1*el(ii-1,0,0)
          write(*,*) 0,ii+1,0
          el(0,ii+1,0)=2*ii*b2min1*el(0,ii-1,0)
          write(*,*) 0,0,ii+1
          el(0,0,ii+1)=2*ii*c2min1*el(0,0,ii-1)
      enddo
c now the side planes (2 nonzero cpts)
      do isum=1,2*n,2
          do jj=1,n/2
              ii=isum-jj
              if (ii.ge.0 .and. ii.lt.n) then
                  write(*,*) ii+1,jj,0
                  el(ii+1,jj,0)=2*ii*a2min1*el(ii-1,jj,0)
     :                +2*jj*ab*el(ii,jj-1,0)
                  write(*,*) ii+1,0,jj
                  el(ii+1,0,jj)=2*ii*a2min1*el(ii-1,0,jj)
     :                +2*jj*ac*el(ii,0,jj-1)
                  write(*,*) 0,ii+1,jj
                  el(0,ii+1,jj)=2*mm*b2min1*el(0,ii-1,jj)
     :                +2*jj*bc*el(0,ii,jj-1)
                  write(*,*) jj,ii+1,0
                  el(jj,ii+1,0)=2*mm*b2min1*el(jj,ii-1,0)
     :                +2*jj*ab*el(jj-1,ii,0)
                  write(*,*) jj,0,ii+1
                  el(jj,0,ii+1)=2*nn*c2min1*el(jj,0,ii-1)
     :                +2*jj*ac*el(jj-1,0,ii)
                  write(*,*) 0,jj,ii+1
                  el(0,jj,ii+1)=2*nn*c2min1*el(0,jj,ii-1)
     :                +2*jj*bc*el(0,jj-1,ii)
              endif
          enddo
      enddo
c finally fill in the internal space
      do isum=3,3*n,2
          do lll=1,n
              do mmm=1,n
                  nnn=isum-lll-mmm
                  if (nnn.gt.0 .and. nnn.le.n) then
                      write(*,*) lll+1,mmm,nnn
                      el(lll+1,mmm,nnn)=2*lll*a2min1*el(lll-1,mmm,nnn)
     :                    +2*mmm*ab*el(lll,mmm-1,nnn)
     :                    +2*nnn*ac*el(lll,mmm,nnn-1)
                      write(*,*) lll,mmm+1,nnn
                      el(lll,mmm+1,nnn)=2*mmm*b2min1*el(lll,mmm-1,nnn)
     :                    +2*mmm*ab*el(lll-1,mmm,nnn)
     :                    +2*nnn*bc*el(lll,mmm,nnn-1)
                  endif
                  if (nnn.ge.0 .and. nnn.le.n-1) then
                      write(*,*) lll,mmm,nnn+1
                      el(lll,mmm,nnn+1)=2*nnn*c2min1*el(lll,mmm,nnn-1)
     :                    +2*mmm*ac*el(lll-1,mmm,nnn)
     :                    +2*nnn*bc*el(lll,mmm-1,nnn)
                  endif
              enddo
          enddo
      enddo

      do i=0,n
          do j=0,n
              do k=0,n
                  write(*,*) i,j,k,el(i,j,k)
              enddo
          enddo
      enddo
      
c
c now turn the el matrix into the 1-D c1d matrices
c



c
c construct the convolution matrix cmat, which gives the relation
c result(k3)= Sum cmat(k3,k1,k2) shape1(k1) shape2(k2)
c
      k1=0
      do nn1=0,n
          do j1=0,nn1
              i1=nn1-j1
              k1=k1+1
              k2=0
              do nn2=0,n
                  do j2=0,nn2
                      i2=nn2-j2
                      k2=k2+1
                      k3=0
                      do nn3=0,n
                          do j3=0,nn3
                              i3=nn3-j3
                              k3=k3+1
                              cmat(k3,k1,k2)=c1d(i3,i1,i2)*c1d(j3,j1,j2)
                          enddo
                      enddo
                  enddo
              enddo
          enddo
      enddo

c 
c operate the convolution matrix on shape 1 and shape2 to give result

      do k3=1,(n+1)*(n+2)/2
          sum=0
          do k1=1,(n1+1)*(n1+2)/2
              do k2=1,(n2+1)*(n2+2)/2
                  sum=sum+cmat(k3,k1,k2)*shape1(k1+2)*shape2(k2+2)
              enddo
          enddo
          result(k3+2)=sum
      enddo

      return
      end

